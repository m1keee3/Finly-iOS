# Finly-iOS

Мобильное приложение для анализа графиков ценных бумаг на основе паттернов. Клиент к микросервисной системе Finly.


## Архитектура

**MVVM + Coordinator**

Разделение ответственности: View только отображает UI и отправляет события пользователя, ViewModel содержит всю презентационную логику (фильтрация, сортировка, подготовка данных), Model представляет данные.

Тестируемость: ViewModel не зависит от UIKit, все зависимости (сервисы, координаторы) внедряются через протоколы. Это позволяет легко подменять реальные сервисы моками в юнит-тестах.

Coordinator для навигации: Выносит логику переходов из ViewController'ов, что делает их легче и переиспользуемыми. Особенно важно для приложения со сложной навигацией (4 экрана с разными сценариями входа).

Соответствие требованиям лабораторной: Чёткие контракты между слоями, отсутствие UIKit в доменных моделях, понятная структура для моков.

Масштабируемость: При добавлении новых экранов (например, детального просмотра паттерна) архитектура не ломается — просто добавляется новый модуль.

---

## Список модулей и их ответственности

| Модуль | Экран | Ответственность |
|:-------|:------|:----------------|
| **Auth** | Экран авторизации | Аутентификация пользователя через Telegram или email, получение сессии |
| **Home** | Главный экран | Агрегация ключевой информации: карточка лучшей бумаги, навигационные плитки |
| **Dashboard** | Экран со списком бумаг | Отображение всех активных паттернов, фильтрация, сортировка, статистика |
| **Scanner** | Экран сканера | Ручной анализ графиков: выбор бумаги, выделение сегмента, настройка параметров |

---

## Описание экранов: вход/выход/сценарии
### 1. Экран авторизации (Auth)
Вход: Приложение запущено, пользователь не авторизован

Выход: Успешная сессия пользователя (UserSession)

**Сценарии:**

Успешный вход через Telegram:

 - Пользователь нажимает "Войти через Telegram"

 - Приложение открывает ссылку на Telegram-бота

 - Пользователь подтверждает вход в боте

 - Приложение получает токен и данные сессии

 - Coordinator выполняет переход на Home-экран

Успешный вход по email:

 - Пользователь вводит email и пароль

 - Нажимает "Войти"

 - ViewModel вызывает AuthService

 - Получена сессия → переход на Home

Ошибка авторизации:

 - Пользователь вводит неверные данные

 - Сервис возвращает ошибку

 - View получает состояние с isLoading: false и текстом ошибки

 - На экране показывается alert с сообщением

### 2. Главный экран (Home)
Вход: Авторизованная сессия пользователя

Выход: Навигация в Dashboard или Scanner

**Сценарии:**

Загрузка данных:

 - Экран открывается → состояние .loading (скелетон)

 - Загружается информация по лучшей бумаге (BestSecurityService)

 - Данные получены → состояние .content с заполненными карточками

Переход в Dashboard:

 - Пользователь нажимает на плитку "Dashboard"

 - ViewModel вызывает coordinator.showDashboard()

 - Открывается экран Dashboard

Переход в Scanner:

 - Пользователь нажимает на плитку "Scanner"

 - ViewModel вызывает coordinator.showScanner()

 - Открывается экран Scanner

Обновление данных:

 - Пользователь тянет экран вниз (pull-to-refresh)

 - Повторно загружается информация по лучшей бумаге

 - UI обновляется

### 3. Экран Dashboard (список бумаг)
Вход: Авторизованная сессия

Выход: детальный просмотр бумаги

**Сценарии:**

Первичная загрузка:

 - Экран открывается → состояние .loading

 - Параллельно загружаются:

   - Статистика (активные паттерны, лучший тикер, средние значения)

   - Список паттернов с пагинацией

 - Все данные получены → отображение таблицы и карточек stats

Применение фильтров:

 - Пользователь открывает панель фильтров

 - Меняет "Мин. совпадений" с 5 на 10

 - Выбирает сортировку "Вероятность"

 - ViewModel обновляет фильтр в state

 - Таблица перерисовывается с отфильтрованными данными

Pull-to-refresh:

 - Пользователь обновляет список

 - Перезапрашиваются все данные

Обработка ошибок:

 - При ошибке загрузки показывается состояние .error

 - Кнопка "Повторить" повторяет запрос

### 4. Экран Scanner
Вход: Авторизованная сессия

Выход: Результаты сканирования

Сценарии:

Инициализация экрана:

 - Загружается список доступных бумаг

 - Устанавливаются параметры поиска по умолчанию

 - График изначально пуст (ожидает выбора бумаги)

Выбор бумаги и загрузка графика:

 - Пользователь выбирает из списка, например, "SBER"

 - Загружаются данные за определенный период

 - Отображается график с возможностью выделить сегмент

Настройка сегмента:

 - Пользователь двигает ползунки, выбирая даты

 - Визуально выделяется выбранный участок

 - Рассчитывается и отображается длина сегмента в днях

Настройка параметров свечного паттерна:

 - Пользователь меняет "Длина хвоста" с 5 на 7

 - Изменяет "Допуск тела %" с 0.1 на 0.15

 - Выбирает временной диапазон для поиска (Поиск с: 19.02.2016)

Выбор целевых бумаг:

 - Пользователь отмечает чекбоксы: SBER, T, LKOH (или выбирает "Все")

 - ViewModel сохраняет выбранные ID в selectedTargetSecurities

Запуск сканирования:

 - Все параметры валидны (выбрана бумага, сегмент, целевые бумаги)

 - Пользователь нажимает "Найти совпадения"

 - Устанавливается состояние .scanning (индикатор загрузки)

 - ScannerService отправляет запрос

 - Получены результаты → отображаются в таблице снизу

Повторный поиск с другими параметрами:

 - Пользователь меняет параметры

 - Предыдущие результаты очищаются или помечаются как неактуальные

 - Новый запуск сканирования

---

## Ключевые протоколы и модели

### Протоколы (контракты)

**Auth Module**

`AuthView` — получение состояния экрана авторизации

`AuthViewModelProtocol` — обработка событий на экране авторизации

`AuthServiceProtocol` — авторизация через Telegram/email

`AuthCoordinatorProtocol` — навигация с экрана авторизации

**Home Module**

`HomeView` — отображение главного экрана

`HomeViewModelProtocol` — логика главного экрана

`BestSecurityServiceProtocol` — загрузка данных по лучшей бумаге

`HomeCoordinatorProtocol` — навигация в Dashboard и Scanner

**Dashboard Module**

`DashboardView` — отображение списка бумаг

`DashboardViewModelProtocol` — логика фильтрации и сортировки

`DashboardServiceProtocol` — загрузка статистики и списка паттернов

`DashboardCoordinatorProtocol` — навигация с экрана Dashboard

**Scanner Module**

`ScannerView` — отображение экрана сканера

`ScannerViewModelProtocol` — логика сканирования

`ScannerServiceProtocol` — загрузка графиков и запуск сканирования

`ScannerCoordinatorProtocol` — навигация с экрана сканера

### Модели данных

**Auth**

`UserSession` — токен и ID пользователя

**Home**

`BestSecurity` — тикер, вероятность, изменение цены

**Dashboard**

`DashboardStats` — количество паттернов, лучший тикер, средние значения

`PatternListItem` — строка таблицы с паттерном

`PatternType` — свечной/графический паттерн

`PatternsFilter` — параметры фильтрации и сортировки

**Scanner**

`Security` — информация о бумаге (символ, название)

`ChartSegment` — выбранный участок графика с датами

`CandlePatternParams` — длина хвоста, допуски, диапазон поиска

`ScanRequest` — запрос на сканирование

`ScanResult` — результат поиска совпадений
